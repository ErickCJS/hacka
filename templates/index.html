{% extends "partials/sidebar.html" %}
{% block title %} Dashboard Central de Monitoreo {% endblock %}
{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #06b6d4;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --bg-main: #f8fafc;
    --bg-card: #ffffff;
    --bg-hover: #f1f5f9;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --border: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.15);
    --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-success: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-warning: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .dashboard-wrapper {
    min-height: 100vh;
    background: linear-gradient(180deg, #f8fafc 0%, #e0e7ff 100%);
    position: relative;
    overflow-x: hidden;
  }

  .dashboard-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header-title h1 {
    font-size: 1.75rem;
    font-weight: 700;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: var(--success);
    color: white;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    animation: pulse 2s infinite;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: blink 1.4s infinite both;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  @keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
  }

  .dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1.5rem;
  }

  .stats-grid {
    grid-column: span 12;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1rem;
  }

  .stat-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border);
    cursor: pointer;
  }

  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-light);
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .stat-card:hover::before {
    transform: scaleX(1);
  }

  .stat-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .stat-icon.denuncias {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .stat-icon.emergencias {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }

  .stat-icon.pendientes-den {
    background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    color: white;
  }

  .stat-icon.pendientes-emer {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    color: white;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin: 0.5rem 0;
    min-height: 2.5rem;
  }

  .stat-description {
    font-size: 0.8125rem;
    color: var(--text-muted);
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
    min-height: 2.5rem;
    display: flex;
    align-items: center;
  }

  .stat-trend {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
  }

  .stat-trend.up {
    color: var(--success);
    background: rgba(16, 185, 129, 0.1);
  }

  .stat-trend.down {
    color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
  }

  .stat-trend.neutral {
    color: var(--text-secondary);
    background: var(--bg-hover);
  }

  .stat-trend.warning {
    color: var(--warning);
    background: rgba(245, 158, 11, 0.1);
  }

  .stat-trend.danger {
    color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
  }

  .main-panel {
    grid-column: span 8;
  }

  .side-panel {
    grid-column: span 4;
  }

  .chart-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .chart-card:hover {
    box-shadow: var(--shadow-lg);
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .chart-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-actions {
    display: flex;
    gap: 0.5rem;
  }

  .chart-action-btn {
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .chart-action-btn:hover,
  .chart-action-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .alert-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  .alert-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
  }

  .alert-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
  }

  .alert-icon.danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }

  .alert-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .alert-item {
    padding: 0.75rem;
    background: var(--bg-hover);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    cursor: pointer;
  }

  .alert-item:hover {
    background: var(--primary);
    color: white;
    transform: translateX(4px);
  }

  .alert-item.danger {
    border-left: 3px solid var(--danger);
  }

  .alert-item.warning {
    border-left: 3px solid var(--warning);
  }

  .alert-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .alert-item:hover .alert-time {
    color: rgba(255, 255, 255, 0.8);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .stat-card,
  .chart-card,
  .alert-card {
    animation: slideInUp 0.6s ease-out backwards;
  }

  .stat-card:nth-child(1) { animation-delay: 0.1s; }
  .stat-card:nth-child(2) { animation-delay: 0.2s; }
  .stat-card:nth-child(3) { animation-delay: 0.25s; }
  .stat-card:nth-child(4) { animation-delay: 0.3s; }
  .chart-card:nth-child(1) { animation-delay: 0.4s; }
  .chart-card:nth-child(2) { animation-delay: 0.5s; }

  .skeleton {
    background: linear-gradient(90deg, var(--bg-hover) 25%, var(--border) 50%, var(--bg-hover) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    min-height: 20px;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  @media (max-width: 1024px) {
    .dashboard-container {
      grid-template-columns: 1fr;
      padding: 1rem;
    }

    .main-panel,
    .side-panel {
      grid-column: span 1;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 640px) {
    .header-title h1 {
      font-size: 1.25rem;
    }

    .stat-value {
      font-size: 1.5rem;
    }

    .chart-card {
      padding: 1rem;
    }

    .chart-actions {
      flex-direction: column;
    }

    .chart-action-btn {
      padding: 0.375rem 0.5rem;
      font-size: 0.75rem;
    }
  }

  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg-hover);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .refreshing {
    animation: rotate 1s linear infinite;
  }

  @keyframes alertPulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
  }

  .new-alert-notification {
    animation: alertPulse 1.5s ease-in-out;
  }
</style>

<div class="dashboard-wrapper">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1>üõ°Ô∏è Central de Monitoreo</h1>
        <span class="status-badge">
          <span class="status-dot"></span>
          Sistema Activo
        </span>
      </div>
      <div class="header-actions">
        <button class="chart-action-btn" onclick="refreshAllData()" id="refreshBtn">
          üîÑ Actualizar
        </button>
        <span id="current-time" style="margin-left: 1rem; color: var(--text-secondary); font-weight: 500;"></span>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-header">
          <div>
            <div class="stat-label">Denuncias Hoy</div>
            <div class="stat-value" id="total-denuncias">0</div>
            <span class="stat-trend neutral" id="trend-denuncias">
              Calculando...
            </span>
          </div>
          <div class="stat-icon denuncias">üìã</div>
        </div>
        <div class="stat-description" id="ultima-denuncia">
          Sin denuncias recientes
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-card-header">
          <div>
            <div class="stat-label">Emergencias Hoy</div>
            <div class="stat-value" id="total-emergencias">0</div>
            <span class="stat-trend neutral" id="trend-emergencias">
              Calculando...
            </span>
          </div>
          <div class="stat-icon emergencias">üö®</div>
        </div>
        <div class="stat-description" id="ultima-emergencia">
          Sin emergencias recientes
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-card-header">
          <div>
            <div class="stat-label">Denuncias Pendientes</div>
            <div class="stat-value" id="total-denuncias-pendientes">0</div>
            <span class="stat-trend warning" id="trend-denuncias-pendientes">
              Sin revisar
            </span>
          </div>
          <div class="stat-icon pendientes-den">‚è≥</div>
        </div>
        <div class="stat-description">
          Esperando revisi√≥n
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-card-header">
          <div>
            <div class="stat-label">Emergencias Pendientes</div>
            <div class="stat-value" id="total-emergencias-pendientes">0</div>
            <span class="stat-trend danger" id="trend-emergencias-pendientes">
              Requiere atenci√≥n
            </span>
          </div>
          <div class="stat-icon pendientes-emer">‚ö†Ô∏è</div>
        </div>
        <div class="stat-description">
          Esperando revisi√≥n urgente
        </div>
      </div>
    </div>

    <div class="main-panel">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            üìä An√°lisis de Severidad por Categor√≠a
          </h3>
          
        </div>
        <div style="height: 400px; position: relative;">
          <canvas id="graficoRadar"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            üìà Tendencia de Reportes
          </h3>
          <div class="chart-actions">
            <button class="chart-action-btn" onclick="changeTimeRange('day')" id="btnDay">Hoy</button>
            <button class="chart-action-btn active" onclick="changeTimeRange('week')" id="btnWeek">Semana</button>
            <button class="chart-action-btn" onclick="changeTimeRange('month')" id="btnMonth">Mes</button>
          </div>
        </div>
        <div style="height: 350px; position: relative;">
          <canvas id="graficoLinealReportes"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            üèÜ Top 5 Tipos de Denuncias (√öltimo Mes)
          </h3>
        </div>
        <div style="height: 300px; position: relative;">
          <canvas id="graficoTopDenuncias"></canvas>
        </div>
      </div>
    </div>

    <div class="side-panel">
      <div class="alert-card">
        <div class="alert-header">
          <div class="alert-icon warning">‚ö°</div>
          <div>
            <h3 style="font-weight: 600; margin: 0;">Alertas Pendientes</h3>
            <p style="color: var(--text-muted); font-size: 0.875rem; margin: 0;">Requieren atenci√≥n</p>
          </div>
        </div>
        <div class="alert-list" id="alertas-list">
          <div class="empty-state">Cargando alertas...</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            üç© Distribuci√≥n Mensual de Incidencias
          </h3>
        </div>
        <div style="height: 300px; position: relative;">
          <canvas id="graficoTipoReporte"></canvas>
        </div>
      </div>

      <div class="alert-card">
        <div class="alert-header">
          <div class="alert-icon danger">üìç</div>
          <div>
            <h3 style="font-weight: 600; margin: 0;">Actividad del D√≠a</h3>
            <p style="color: var(--text-muted); font-size: 0.875rem; margin: 0;">Tiempo real</p>
          </div>
        </div>
        <div class="alert-list" id="actividad-list">
          <div class="empty-state">Sin actividad reciente</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUDIO PARA ALERTAS - Aseg√∫rate que el archivo existe en: static/audio/alerta.mp3 -->
<audio id="alert-sound" preload="auto">
  <source src="/static/audio/alerta.mp3" type="audio/mp3">
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

<script>
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = '#64748b';
  
  let graficoRadar = null;
  let graficoLineal = null;
  let graficoDoughnut = null;
  let graficoTop = null;
  let currentTimeRange = 'week';
  let ultimoDenunciasTotal = 0;
  let ultimoEmergenciasTotal = 0;
  let audioEnabled = true;

  // URL base para las APIs
  const BASE_URL = '{{ BASE_URL }}' || '/api/central';

  console.log('BASE_URL:', BASE_URL);

  function playAlertSound() {
    if (audioEnabled) {
      try {
        const audio = document.getElementById('alert-sound');
        if (audio) {
          console.log('Reproduciendo audio de alerta...');
          audio.currentTime = 0;
          audio.play().then(() => {
            console.log('Audio reproducido exitosamente');
          }).catch(err => {
            console.log('Error al reproducir audio:', err);
          });
        } else {
          console.log('Elemento de audio no encontrado');
        }
      } catch (e) {
        console.log('Error en playAlertSound:', e);
      }
    }
  }

  function updateTime() {
    const now = new Date();
    const options = { 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit',
      hour12: false 
    };
    document.getElementById('current-time').textContent = 
      now.toLocaleDateString('es-PE') + ' ' + now.toLocaleTimeString('es-PE', options);
  }
  setInterval(updateTime, 1000);
  updateTime();

  function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    
    if (end === 0) {
      obj.textContent = '0';
      return;
    }
    
    const range = end - start;
    const minTimer = 50;
    let stepTime = Math.abs(Math.floor(duration / range));
    stepTime = Math.max(stepTime, minTimer);
    const startTime = new Date().getTime();
    const endTime = startTime + duration;
    
    function run() {
      const now = new Date().getTime();
      const remaining = Math.max((endTime - now) / duration, 0);
      const value = Math.round(end - (remaining * range));
      obj.textContent = value;
      if (value == end) {
        return;
      }
      setTimeout(run, stepTime);
    }
    run();
  }

  function mostrarNotificacion(mensaje, tipo) {
    const alertCard = document.querySelector('.alert-card');
    if (alertCard) {
      alertCard.classList.add('new-alert-notification');
      setTimeout(() => {
        alertCard.classList.remove('new-alert-notification');
      }, 1500);
    }
  }

  function actualizarTarjetas() {
    console.log('Actualizando tarjetas...');
    
    fetch(BASE_URL + '/api/central/stats/totales_dia')
      .then(res => res.json())
      .then(data => {
        console.log('Datos totales d√≠a:', data);
        const nuevasDenuncias = data.denuncias || 0;
        const nuevasEmergencias = data.emergencias || 0;
        
        if (ultimoDenunciasTotal > 0 && nuevasDenuncias > ultimoDenunciasTotal) {
          playAlertSoundRobust();
          mostrarNotificacion('Nueva Denuncia Registrada', 'warning');
        }
        
        if (ultimoEmergenciasTotal > 0 && nuevasEmergencias > ultimoEmergenciasTotal) {
          playAlertSoundRobust();
          mostrarNotificacion('Nueva Emergencia Registrada', 'danger');
        }
        
        ultimoDenunciasTotal = nuevasDenuncias;
        ultimoEmergenciasTotal = nuevasEmergencias;
        
        animateValue("total-denuncias", 0, nuevasDenuncias, 500);
        animateValue("total-emergencias", 0, nuevasEmergencias, 500);
      })
      .catch(err => {
        console.error('Error totales d√≠a:', err);
        document.getElementById("total-denuncias").textContent = '0';
        document.getElementById("total-emergencias").textContent = '0';
      });

    fetch(BASE_URL + '/api/central/stats/totales_pendientes')
      .then(res => res.json())
      .then(data => {
        console.log('Datos pendientes:', data);
        animateValue("total-denuncias-pendientes", 0, data.denuncias_pendientes || 0, 1000);
        animateValue("total-emergencias-pendientes", 0, data.emergencias_pendientes || 0, 1000);
      })
      .catch(err => {
        console.error('Error pendientes:', err);
        document.getElementById("total-denuncias-pendientes").textContent = '0';
        document.getElementById("total-emergencias-pendientes").textContent = '0';
      });

    fetch(BASE_URL + '/api/central/stats/tendencias')
      .then(res => res.json())
      .then(data => {
        const trendDenuncias = document.getElementById("trend-denuncias");
        const trendEmergencias = document.getElementById("trend-emergencias");
        
        if (data.denuncias) {
          trendDenuncias.className = `stat-trend ${data.denuncias.direccion}`;
          const arrow = data.denuncias.direccion === 'up' ? '‚Üë' : 
                       data.denuncias.direccion === 'down' ? '‚Üì' : '‚Üí';
          trendDenuncias.innerHTML = `${arrow} ${Math.abs(data.denuncias.porcentaje)}% vs mes anterior`;
        }
        
        if (data.emergencias) {
          trendEmergencias.className = `stat-trend ${data.emergencias.direccion}`;
          const arrow = data.emergencias.direccion === 'up' ? '‚Üë' : 
                       data.emergencias.direccion === 'down' ? '‚Üì' : '‚Üí';
          trendEmergencias.innerHTML = `${arrow} ${Math.abs(data.emergencias.porcentaje)}% vs mes anterior`;
        }
      })
      .catch(err => {
        console.error('Error tendencias:', err);
      });

    fetch(BASE_URL + '/api/central/stats/ultima_denuncia')
      .then(res => res.ok ? res.json() : Promise.reject('No hay denuncias'))
      .then(text => {
        const elem = document.getElementById("ultima-denuncia");
        elem.innerHTML = `üìç ${text}`;
      })
      .catch(() => {
        document.getElementById("ultima-denuncia").innerHTML = "Sin denuncias recientes";
      });

    fetch(BASE_URL + '/api/central/stats/ultima_emergencia')
      .then(res => res.ok ? res.json() : Promise.reject('No hay emergencias'))
      .then(text => {
        const elem = document.getElementById("ultima-emergencia");
        elem.innerHTML = `üö® ${text}`;
      })
      .catch(() => {
        document.getElementById("ultima-emergencia").innerHTML = "Sin emergencias recientes";
      });
  }

  function actualizarAlertas() {
    console.log('Actualizando alertas...');
    fetch(BASE_URL + '/api/central/stats/alertas_pendientes')
      .then(res => res.json())
      .then(alertas => {
        console.log('Alertas recibidas:', alertas);
        const container = document.getElementById('alertas-list');
        
        if (alertas && alertas.length > 0) {
          container.innerHTML = alertas.map(alerta => `
            <div class="alert-item ${alerta.tipo}" onclick="redirigirAlerta('${alerta.tipo_incidencia}', '${alerta.id}')">
              <span>${alerta.descripcion}</span>
              <span class="alert-time">${alerta.tiempo}</span>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state">No hay alertas pendientes</div>';
        }
      })
      .catch(err => {
        console.error('Error alertas:', err);
        document.getElementById('alertas-list').innerHTML = 
          '<div class="empty-state">Error al cargar alertas</div>';
      });
  }

  function redirigirAlerta(tipoIncidencia, idIncidencia) {
    console.log(`Redirigiendo a ${tipoIncidencia} ${idIncidencia}`);
    if (tipoIncidencia === 'denuncia') {
      window.location.href = `{{ BASE_URL }}/denuncias/detalle/${idIncidencia}/editar`;
    } else if (tipoIncidencia === 'emergencia') {
      window.location.href = `{{ BASE_URL }}/emergencias/detalle/${idIncidencia}/editar`;
    }
  }

  function actualizarActividad() {
    fetch(BASE_URL + '/api/central/stats/actividad_real')
      .then(res => res.json())
      .then(actividades => {
        const container = document.getElementById('actividad-list');
        
        if (actividades && actividades.length > 0) {
          container.innerHTML = actividades.map(act => `
            <div class="alert-item">
              <span>${act.actividad}</span>
              <span class="alert-time">${act.hora}</span>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state">Sin actividad reciente</div>';
        }
      })
      .catch(err => {
        console.error('Error actividad:', err);
      });
  }

  function crearGraficoRadar() {
    fetch(BASE_URL + '/api/central/stats/severidad')
      .then(res => res.json())
      .then(datosRadar => {
        const ctx = document.getElementById('graficoRadar').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.6)');
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.1)');

        if (graficoRadar) graficoRadar.destroy();

        graficoRadar = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: datosRadar.labels,
            datasets: [{
              label: 'Nivel de Severidad',
              data: datosRadar.severidades,
              fill: true,
              backgroundColor: gradient,
              borderColor: '#6366f1',
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#6366f1',
              pointRadius: 6,
              pointHoverRadius: 8,
              borderWidth: 3,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                titleColor: '#fff',
                bodyColor: '#cbd5e1',
                borderColor: '#6366f1',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12
              }
            },
            scales: {
              r: {
                min: 0,
                max: 5,
                ticks: {
                  stepSize: 1,
                  color: '#94a3b8',
                  backdropColor: 'transparent',
                  font: {
                    size: 11
                  }
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.1)',
                  lineWidth: 1
                },
                pointLabels: {
                  color: '#475569',
                  font: {
                    size: 11,
                    weight: '500'
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Error radar:', error));
  }

  function changeTimeRange(range) {
    currentTimeRange = range;
    
    document.querySelectorAll('.chart-actions button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    if (range === 'day') {
      document.getElementById('btnDay').classList.add('active');
      actualizarGraficoPorHora();
    } else if (range === 'week') {
      document.getElementById('btnWeek').classList.add('active');
      actualizarGraficoSemanal();
    } else if (range === 'month') {
      document.getElementById('btnMonth').classList.add('active');
      actualizarGraficoLineal();
    }
  }

  function actualizarGraficoPorHora() {
    fetch(BASE_URL + '/api/central/stats/por_hora')
      .then(res => res.json())
      .then(data => {
        actualizarGraficoLinealConDatos(data, 'Distribuci√≥n por Hora - Hoy');
      })
      .catch(err => console.error('Error:', err));
  }

  function actualizarGraficoSemanal() {
    fetch(BASE_URL + '/api/central/stats/resumen_semanal')
      .then(res => res.json())
      .then(data => {
        actualizarGraficoLinealConDatos({
          labels: data.labels,
          denuncias: data.denuncias,
          emergencias: data.emergencias
        }, 'Resumen √öltima Semana');
      })
      .catch(err => console.error('Error:', err));
  }

  function actualizarGraficoLineal() {
    fetch(BASE_URL + '/api/central/stats/reportes_fecha')
      .then(res => res.json())
      .then(data => {
        actualizarGraficoLinealConDatos(data, '√öltimos 30 d√≠as');
      })
      .catch(err => console.error('Error:', err));
  }

  function actualizarGraficoLinealConDatos(data, titulo) {
    const ctx = document.getElementById('graficoLinealReportes').getContext('2d');
    
    const gradientDenuncias = ctx.createLinearGradient(0, 0, 0, 350);
    gradientDenuncias.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
    gradientDenuncias.addColorStop(1, 'rgba(99, 102, 241, 0)');
    
    const gradientEmergencias = ctx.createLinearGradient(0, 0, 0, 350);
    gradientEmergencias.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
    gradientEmergencias.addColorStop(1, 'rgba(239, 68, 68, 0)');

    if (graficoLineal) graficoLineal.destroy();

    graficoLineal = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: 'Denuncias',
            data: data.denuncias,
            borderColor: '#6366f1',
            backgroundColor: gradientDenuncias,
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointBackgroundColor: '#6366f1',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          },
          {
            label: 'Emergencias',
            data: data.emergencias,
            borderColor: '#ef4444',
            backgroundColor: gradientEmergencias,
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointBackgroundColor: '#ef4444',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          title: {
            display: true,
            text: titulo,
            font: {
              size: 14,
              weight: '500'
            },
            color: '#64748b'
          },
          legend: {
            display: true,
            position: 'top',
            align: 'end',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12,
                weight: '500'
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            titleColor: '#fff',
            bodyColor: '#cbd5e1',
            borderColor: '#64748b',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: true,
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(148, 163, 184, 0.08)',
              drawBorder: false
            },
            ticks: {
              precision: 0,
              color: '#64748b',
              font: {
                size: 11
              }
            }
          },
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              color: '#64748b',
              font: {
                size: 11
              },
              maxRotation: 0
            }
          }
        }
      }
    });
  }

  function crearGraficoDoughnut() {
    fetch(BASE_URL + '/api/central/stats/doughnut')
      .then(res => res.json())
      .then(datos => {
        const ctx = document.getElementById('graficoTipoReporte').getContext('2d');
        
        if (graficoDoughnut) graficoDoughnut.destroy();
        
        graficoDoughnut = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Denuncias', 'Emergencias'],
            datasets: [{
              data: [datos.denuncia || 0, datos.emergencia || 0],
              backgroundColor: [
                '#6366f1',
                '#ef4444'
              ],
              borderWidth: 0,
              spacing: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  font: {
                    size: 12,
                    weight: '500'
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                titleColor: '#fff',
                bodyColor: '#cbd5e1',
                borderColor: '#64748b',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Error doughnut:', error));
  }

  function crearGraficoTop() {
    fetch(BASE_URL + '/api/central/stats/top_denuncias')
      .then(res => res.json())
      .then(datos => {
        const ctx = document.getElementById('graficoTopDenuncias').getContext('2d');
        
        if (graficoTop) graficoTop.destroy();
        
        graficoTop = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels || [],
            datasets: [{
              label: 'Cantidad',
              data: datos.valores || [],
              backgroundColor: 'rgba(99, 102, 241, 0.8)',
              borderColor: '#6366f1',
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                titleColor: '#fff',
                bodyColor: '#cbd5e1',
                borderColor: '#6366f1',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(148, 163, 184, 0.08)',
                  drawBorder: false
                },
                ticks: {
                  precision: 0,
                  color: '#64748b'
                }
              },
              y: {
                grid: {
                  display: false,
                  drawBorder: false
                },
                ticks: {
                  color: '#64748b',
                  font: {
                    size: 12
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Error top denuncias:', error));
  }

  function refreshAllData() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('refreshing');
    
    actualizarTarjetas();
    actualizarAlertas();
    actualizarActividad();
    crearGraficoRadar();
    changeTimeRange(currentTimeRange);
    crearGraficoDoughnut();
    crearGraficoTop();
    
    setTimeout(() => {
      btn.classList.remove('refreshing');
    }, 1000);
  }

  function exportChart(type) {
    alert('Funci√≥n de exportaci√≥n en desarrollo');
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard iniciado');
    actualizarTarjetas();
    actualizarAlertas();
    actualizarActividad();
    crearGraficoRadar();
    actualizarGraficoSemanal();
    crearGraficoDoughnut();
    crearGraficoTop();
    
    // Actualizaciones peri√≥dicas
    setInterval(actualizarTarjetas, 30000);
    setInterval(actualizarAlertas, 60000);
    setInterval(actualizarActividad, 45000);
    setInterval(() => {
      changeTimeRange(currentTimeRange);
    }, 300000);
  });

  // ============ SOLUCI√ìN 1: Audio Simple (SIN archivo externo) ============
// Esta soluci√≥n crea el sonido directamente en JavaScript
// No necesita archivo externo, funciona siempre
const alarmaSeria = new Howl({
            src: ["static/audio/alerta.mp3"], // cambia por tu ruta
            volume: 1.0,
            html5: true
        });

function playAlertSoundBuiltIn() {
    try {
        
        alarmaSeria.play();
        console.log("üî• Sirena seria reproducida con Howler.js");
    } catch (e) {
        console.error("‚ùå Error reproduciendo sirena con Howler.js:", e);
    }
}


// Llamar as√≠:
// playAlertSoundBuiltIn();


// ============ SOLUCI√ìN 2: Audio con Archivo Externo (Mejorado) ============
// Reemplaza la funci√≥n playAlertSound original con esta

function playAlertSound() {
    console.group("üîä DEBUG: playAlertSound()");

    const audio = document.getElementById("alert-sound");

    // 1. Verificar si el elemento existe
    if (!audio) {
        console.error("‚ùå ERROR: No existe <audio id='alertSound'> en el HTML");
        console.groupEnd();
        return;
    }

    console.log("‚úî Elemento encontrado:", audio);

    // 2. Verificar si tiene atributo SRC
    if (!audio.src) {
        console.error("‚ùå ERROR: El elemento audio no tiene atributo SRC.");
        console.warn("üëâ Revisa si tienes algo como: <audio id='alertSound' src='/static/sonidos/alert.mp3'></audio>");
        console.groupEnd();
        return;
    }

    console.log("‚úî SRC detectado:", audio.src);

    // 3. Verificar si el archivo realmente existe (fetch)
    console.log("üîç Verificando si el archivo de audio existe...");

    const startCheck = performance.now();
    fetch(audio.src, { method: "HEAD" })
        .then(response => {
            const loadTime = (performance.now() - startCheck).toFixed(2);
            console.log(`‚è± Tiempo de verificaci√≥n: ${loadTime} ms`);

            if (!response.ok) {
                console.error(`‚ùå ERROR: El archivo de audio NO existe o no se puede acceder (${response.status})`);
                console.groupEnd();
                return Promise.reject("Archivo inexistente");
            }

            console.log("‚úî Archivo accesible. Estado:", response.status);

            // 4. Intentar reproducir
            console.log("‚ñ∂ Intentando reproducir audio...");

            const startPlay = performance.now();
            return audio.play()
                .then(() => {
                    const playTime = (performance.now() - startPlay).toFixed(2);
                    console.log(`üîä Audio reproducido correctamente en ${playTime} ms`);
                });
        })
        .catch(err => {
            console.error("‚ùå ERROR al reproducir audio:", err);
        })
        .finally(() => {
            console.groupEnd();
        });

    // 5. Evento onerror del propio elemento
    audio.onerror = function (e) {
        console.error("‚ùå EVENTO error en el audio:", e);
        console.warn("Posibles causas:");
        console.warn(" - Ruta incorrecta");
        console.warn(" - Formato no compatible");
        console.warn(" - Error en permisos");
    };

    // 6. Logs extra cuando cargue metadata
    audio.onloadedmetadata = () => {
        console.log("‚Ñπ Audio metadata cargada:");
        console.log("   Duration:", audio.duration);
        console.log("   Type:", audio.type);
    };

    // 7. Logs para debugging por autoplay
    audio.onplay = () => console.log("üéµ Evento: onplay disparado");
    audio.onpause = () => console.log("‚è∏ Evento: onpause disparado");
}



// ============ SOLUCI√ìN 3: Versi√≥n Robusta con Fallbacks ============
// Esta es la m√°s confiable, √∫sala si las otras no funcionan

function playAlertSoundRobust() {
    console.log('üéµ Iniciando reproducci√≥n de alerta...');
    
    if (!audioEnabled) {
        console.log('‚è∏Ô∏è Audio deshabilitado');
        return;
    }
    
    // Intento 1: Archivo de audio
    try {
        const audio = document.getElementById('alert-sound');
        if (audio && audio.src) {
            console.log('Intento 1: Audio file');
            audio.currentTime = 0;
            audio.volume = 1.0; // Asegurar volumen m√°ximo
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('‚úÖ √âxito: Audio file reproducido');
                    return; // Si funciona, sal
                }).catch(() => {
                    console.log('‚ö†Ô∏è Audio file fall√≥, intentando m√©todo 2...');
                    playAlertSoundBuiltIn();
                });
                return;
            }
        }
    } catch (e) {
        console.log('‚ö†Ô∏è Intento 1 fall√≥:', e.message);
    }
    
    // Intento 2: Generar audio con Web Audio API
    try {
        console.log('Intento 2: Web Audio API');
        playAlertSoundBuiltIn();
    } catch (e) {
        console.log('‚ö†Ô∏è Intento 2 fall√≥:', e.message);
    }
}


// ============ VERIFICACI√ìN Y DEBUG ============
// Ejecuta esto en la consola del navegador para diagnosticar

function debugAudio() {
    console.log('========== DEBUG AUDIO ==========');
    
    const audio = document.getElementById('alert-sound');
    console.log('1. Elemento audio existe:', !!audio);
    
    if (audio) {
        console.log('2. URL del audio:', audio.src);
        console.log('3. Volumen:', audio.volume);
        console.log('4. Muted:', audio.muted);
        console.log('5. Tipo MIME:', audio.type);
        console.log('6. Estado canplay:', audio.canPlayType('audio/mpeg'));
        
        // Intenta reproducir
        console.log('\n7. Intentando reproducir...');
        audio.play()
            .then(() => console.log('‚úÖ Play() funcion√≥'))
            .catch(err => console.error('‚ùå Play() fall√≥:', err));
    } else {
        console.error('‚ùå No se encontr√≥ elemento audio');
    }
    
    console.log('==============================');
}

// Llamar: debugAudio()


// ============ REEMPLAZA EN EL HTML ============
// En tu HTML, reemplaza la funci√≥n playAlertSound original con playAlertSoundRobust
// Luego en actualizarTarjetas(), cambia:
// playAlertSound();  ‚Üê VIEJO
// Por:
// playAlertSoundRobust();  ‚Üê NUEVO

// O usa la versi√≥n builtin que no necesita archivo:
// playAlertSoundBuiltIn();
</script>

{% endblock %}