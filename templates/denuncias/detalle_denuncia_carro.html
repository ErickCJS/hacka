{% extends "partials/sidebar.html" %}
{% block title %}Detalle de Denuncia Vehicular{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
:root {
    --primary:#1f8b4c;
    --secondary:#0c5a2d;
    --bg:#f4f6f9;
    --card:#fff;
    --text:#222;
    --text-light:#666;
    --border:#ddd;
    --radius:14px;
    --shadow:0 4px 14px rgba(0,0,0,.06);
}
.page {
    padding:25px 35px;
    background:var(--bg);
    min-height:100vh;
}
.title {
    font-size:28px;
    font-weight:800;
    text-align:center;
    margin-bottom:20px;
}
.title i { color:var(--primary); }

/* GRID DOS COLUMNAS */
.data-grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:25px;
    margin-bottom:25px;
}

.card {
    background:var(--card);
    padding:20px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
}

.section-title{
    font-size:18px;
    font-weight:700;
    color:var(--text);
    margin-bottom:12px;
    display:flex;
    align-items:center;
    gap:10px;
}
.section-title i { color:var(--primary); }

/* ITEMS */
.info-box{
    background:#f9fbfd;
    padding:12px 16px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    display:flex;
    gap:12px;
    margin-bottom:10px;
}
.info-box i{
    color:var(--primary);
    font-size:18px;
    margin-top:3px;
}
.info-label{ font-size:12px; color:var(--text-light); font-weight:700; }
.info-value{ font-size:15px; color:var(--text); font-weight:600; }

/* BADGES */
.badge{
    padding:6px 14px;
    border-radius:20px;
    font-size:13px;
    font-weight:700;
}
.badge-pending{ background:#FFC107; }
.badge-accepted{ background:#28a745; color:white; }
.badge-rejected{ background:#DC3545; color:white; }

/* MULTIMEDIA */
.media-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(150px,1fr));
    gap:14px;
}
.media-card{
    overflow:hidden;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
}
.media-card img,
.media-card video{
    width:100%; height:120px; object-fit:cover;
}

/* MAPA */
#map {
    width:100%;
    height:420px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
}

/* RESPONSIVE */
@media(max-width:900px){
    .data-grid{ grid-template-columns:1fr; }
}
</style>


<div class="page">

    <h1 class="title">
        <i class="fas fa-car"></i> Detalle de Denuncia Vehicular
    </h1>

    <!-- =================================================== -->
    <!-- 2 COLUMNAS DE INFORMACIÓN ARRIBA -->
    <!-- =================================================== -->
    <div class="data-grid" id="data-grid"></div>

    <!-- =================================================== -->
    <!-- MAPA ABAJO A TODO EL ANCHO -->
    <!-- =================================================== -->
    <div class="card">
        <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Ubicación</h3>
        <div id="map"></div>
    </div>

</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
fetch("{{ BASE_URL }}/api/central/denuncias/detalle/carro/{{ id }}")
    .then(res => res.json())
    .then(data => {

        const d = data.denuncia;

        /* UBICACIÓN */
        let lat=0,lng=0;
        if(d.ubicacion && d.ubicacion.includes(",")){
            [lat,lng]=d.ubicacion.split(",").map(Number);
        }

        /* ESTADO BADGE */
        let badgeClass="badge-pending", badgeText="Pendiente";
        if(d.estado=="2"){ badgeClass="badge-accepted"; badgeText="Aceptada"; }
        if(d.estado=="3"){ badgeClass="badge-rejected"; badgeText="Rechazada"; }

        /* VEHICULO */
        let vehiculoHTML = "";
        if(d.vehiculo){
            vehiculoHTML = `
                <h3 class="section-title"><i class="fas fa-car-side"></i> Información Vehicular</h3>
                <div class="info-box"><i class="fas fa-id-card"></i>
                    <div><div class="info-label">Placa</div><div class="info-value">${d.vehiculo.placa}</div></div>
                </div>
                <div class="info-box"><i class="fas fa-palette"></i>
                    <div><div class="info-label">Color</div><div class="info-value">${d.vehiculo.color}</div></div>
                </div>
                <div class="info-box"><i class="fas fa-car"></i>
                    <div><div class="info-label">Tipo</div><div class="info-value">${d.vehiculo.tipo_vehiculo}</div></div>
                </div>
                <div class="info-box"><i class="fas fa-phone"></i>
                    <div><div class="info-label">Teléfono</div><div class="info-value">${d.vehiculo.telefono ?? "No disponible"}</div></div>
                </div>
            `;
        }

        /* COLUMNA 1 - DATOS */
        const col1 = `
            <div class="card">
                <h3 class="section-title">
                    <i class="fas fa-info-circle"></i> Datos Generales
                    <span class="badge ${badgeClass}" style="margin-left:auto;">${badgeText}</span>
                </h3>

                <div class="info-box"><i class="fas fa-user"></i>
                    <div><div class="info-label">Reportado por</div><div class="info-value">${d.nombre_completo}</div></div>
                </div>

                <div class="info-box"><i class="fas fa-phone"></i>
                    <div><div class="info-label">Teléfono</div><div class="info-value">${d.numero_celular}</div></div>
                </div>

                <div class="info-box"><i class="fas fa-calendar-alt"></i>
                    <div><div class="info-label">Fecha</div><div class="info-value">${d.fecha}</div></div>
                </div>

                <div class="info-box"><i class="fas fa-clock"></i>
                    <div><div class="info-label">Hora</div><div class="info-value">${d.hora}</div></div>
                </div>

                ${vehiculoHTML}
            </div>
        `;

        /* COLUMNA 2 - DESCRIPCIÓN + MULTIMEDIA */
        const col2 = `
            <div class="card">

                <h3 class="section-title"><i class="fas fa-align-left"></i> Descripción</h3>
                <div class="info-box"><i class="fas fa-quote-left"></i>
                    <div class="info-value">${d.descripcion}</div>
                </div>

                <h3 class="section-title"><i class="fas fa-photo-video"></i> Multimedia</h3>

                <div class="media-grid">
                    ${d.fotos.map(f => `<div class="media-card"><img src="${f}"></div>`).join("")}
                </div>

                <div class="media-grid" style="margin-top:15px;">
                    ${d.videos.map(v => `<div class="media-card"><video controls src="${v}"></video></div>`).join("")}
                </div>

                ${d.audios.map((a,i)=>`
                    <div class="info-box">
                        <i class="fas fa-volume-high"></i>
                        <div>
                            <div class="info-label">Audio ${i+1}</div>
                            <audio controls src="${a}" style="width:100%; margin-top:5px;"></audio>
                        </div>
                    </div>
                `).join("")}

            </div>
        `;

        document.getElementById("data-grid").innerHTML = col1 + col2;

        /* MAPA */
        const map = L.map("map").setView([lat,lng],16);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        if(lat && lng) L.marker([lat,lng]).addTo(map);
    });
</script>

{% endblock %}
