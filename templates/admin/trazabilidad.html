<!-- templates/trazabilidad_sectores.html -->

{% extends "partials/sidebar.html" %}

{% block title %} Trazabilidad de Sectores - Central {% endblock %}

{% block content %}
<div class="trazabilidad-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="icon-wrapper">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <div>
                    <h1>Trazabilidad de Sectores</h1>
                    <p>Sistema de gesti√≥n y an√°lisis geogr√°fico de sectores municipales</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="togglePanel('left')">
                    <i class="fas fa-tools"></i>
                    <span>Herramientas</span>
                </button>
                <button class="btn btn-outline" onclick="togglePanel('right')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Gesti√≥n</span>
                </button>
                <button class="btn btn-primary" onclick="cargarSectoresExistentes()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Actualizar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="main-container">
        <!-- Panel izquierdo -->
        <div class="left-panel panel-collapsible" id="leftPanel">
            <div class="panel-header">
                <h3><i class="fas fa-tools"></i> Panel de Control</h3>
                <button class="btn-collapse" onclick="collapsePanel('left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <!-- Estilos de Mapa -->
            <div class="panel-section">
                <button class="accordion-header active" onclick="toggleAccordion(this)">
                    <div class="accordion-title">
                        <i class="fas fa-map"></i>
                        <span>Estilo del Mapa</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </button>
                <div class="accordion-content" style="display: block;">
                    <div class="map-styles-grid">
                        <button class="map-style-card active" data-style="streets-v12" onclick="cambiarEstiloMapa('streets-v12', this)">
                            <i class="fas fa-map"></i>
                            <span>Calles</span>
                        </button>
                        <button class="map-style-card" data-style="satellite-streets-v12" onclick="cambiarEstiloMapa('satellite-streets-v12', this)">
                            <i class="fas fa-satellite"></i>
                            <span>Sat√©lite</span>
                        </button>
                        <button class="map-style-card" data-style="outdoors-v12" onclick="cambiarEstiloMapa('outdoors-v12', this)">
                            <i class="fas fa-mountain"></i>
                            <span>Terreno</span>
                        </button>
                        <button class="map-style-card" data-style="dark-v11" onclick="cambiarEstiloMapa('dark-v11', this)">
                            <i class="fas fa-moon"></i>
                            <span>Oscuro</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Herramientas -->
            <div class="panel-section">
                <button class="accordion-header active" onclick="toggleAccordion(this)">
                    <div class="accordion-title">
                        <i class="fas fa-pencil-ruler"></i>
                        <span>Herramientas de Dibujo</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </button>
                <div class="accordion-content" style="display: block;">
                    <div class="tools-list">
                        <button class="tool-item" id="drawPolygon" onclick="activarDibujo()">
                            <i class="fas fa-draw-polygon"></i>
                            <span>Dibujar Pol√≠gono</span>
                        </button>
                        <button class="tool-item" id="editShape" onclick="activarEdicion()">
                            <i class="fas fa-edit"></i>
                            <span>Editar Forma</span>
                        </button>
                        <button class="tool-item" id="deleteShape" onclick="eliminarForma()">
                            <i class="fas fa-trash"></i>
                            <span>Eliminar Forma</span>
                        </button>
                        <button class="tool-item" id="cancelDraw" onclick="cancelarDibujo()" style="display: none;">
                            <i class="fas fa-times"></i>
                            <span>Cancelar Dibujo</span>
                        </button>
                        <button class="tool-item" onclick="limpiarMapa()">
                            <i class="fas fa-eraser"></i>
                            <span>Limpiar Canvas</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Sectores -->
            <div class="panel-section flex-grow">
                <button class="accordion-header active" onclick="toggleAccordion(this)">
                    <div class="accordion-title">
                        <i class="fas fa-list"></i>
                        <span>Sectores Registrados</span>
                        <span class="badge badge-primary" id="totalSectores">0</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </button>
                <div class="accordion-content" style="display: block;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchSector" placeholder="Buscar sector..." onkeyup="filtrarSectores()">
                    </div>
                    <div id="listaSectores" class="sectores-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Cargando sectores...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√≥n expandir izquierdo -->
        <button class="panel-expand-btn left-expand" onclick="expandPanel('left')" style="display: none;">
            <i class="fas fa-chevron-right"></i>
            <span>Herramientas</span>
        </button>

        <!-- Mapa central -->
        <div class="map-wrapper">
            <div id="map"></div>

            <!-- Leyenda -->
            <div class="map-legend">
                <div class="legend-header">
                    <i class="fas fa-layer-group"></i>
                    <span>Leyenda</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #e74c3c;"></span>
                    <span>Zona Picante</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #3498db;"></span>
                    <span>Zona Tranquila</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #27ae60;"></span>
                    <span>Zona Normal</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #3498db; opacity: 0.4;"></span>
                    <span>Sector en edici√≥n</span>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <i class="fas fa-circle status-dot"></i>
                    <span id="mapStatus">Sistema listo</span>
                </div>
                <div class="status-divider"></div>
                <div class="status-item">
                    <i class="fas fa-crosshairs"></i>
                    <span id="coordinates">-79.8145, -6.8650</span>
                </div>
            </div>

            <!-- Controles -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="map.zoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-control-btn" onclick="map.zoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="map-control-btn" onclick="resetMapView()">
                    <i class="fas fa-home"></i>
                </button>
                <button class="map-control-btn" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>

        <!-- Bot√≥n expandir derecho -->
        <button class="panel-expand-btn right-expand" onclick="expandPanel('right')" style="display: none;">
            <span>Gesti√≥n</span>
            <i class="fas fa-chevron-left"></i>
        </button>

        <!-- Panel derecho -->
        <div class="right-panel panel-collapsible" id="rightPanel">
            <div class="panel-header">
                <h3 id="rightPanelTitle"><i class="fas fa-plus-circle"></i> Gesti√≥n de Sectores</h3>
                <button class="btn-collapse" onclick="collapsePanel('right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Formulario -->
            <div class="panel-section">
                <button class="accordion-header active" onclick="toggleAccordion(this)">
                    <div class="accordion-title">
                        <i class="fas fa-edit" id="formIcon"></i>
                        <span id="formTitle">Nuevo Sector</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </button>
                <div class="accordion-content" style="display: block;">
                    <form id="formSector" onsubmit="event.preventDefault(); guardarSector();">
                        <input type="hidden" id="sectorIdEdit" value="">
                        <input type="hidden" id="modoEdicion" value="false">

                        <div class="form-group">
                            <label for="codigoSector">
                                <i class="fas fa-barcode"></i> C√≥digo del Sector
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="codigoSector" class="form-control" placeholder="Ej: SECT-01" required maxlength="20">
                            <small class="form-hint">Identificador √∫nico</small>
                        </div>

                        <div class="form-group">
                            <label for="nombreSector">
                                <i class="fas fa-tag"></i> Nombre del Sector
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="nombreSector" class="form-control" placeholder="Ej: Centro Hist√≥rico" required maxlength="100">
                            <small class="form-hint">Nombre descriptivo</small>
                        </div>

                        <div class="form-group">
                            <label for="descripcionSector">
                                <i class="fas fa-align-left"></i> Descripci√≥n
                            </label>
                            <textarea id="descripcionSector" class="form-control" placeholder="Descripci√≥n del sector..." rows="3" maxlength="500"></textarea>
                            <small class="form-hint">Opcional</small>
                        </div>

                        <div class="form-group">
                            <label for="tipoZona">
                                <i class="fas fa-flag"></i> Tipo de Zona
                                <span class="required">*</span>
                            </label>
                            <select id="tipoZona" class="form-control" required>
                                <option value="normal">Zona Normal</option>
                                <option value="tranquila">Zona Tranquila</option>
                                <option value="picante">Zona Picante</option>
                            </select>
                            <small class="form-hint">Clasificaci√≥n general del sector</small>
                        </div>

                        <div class="polygon-status" id="polygonStatus">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Pol√≠gono requerido</strong>
                                <p>Dibuja un √°rea en el mapa</p>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-block" id="btnGuardar" disabled>
                                <i class="fas fa-save"></i>
                                <span id="btnGuardarTexto">Guardar Sector</span>
                            </button>
                            <button type="button" class="btn btn-secondary btn-block" id="btnCancelar" onclick="cancelarEdicion()" style="display: none;">
                                <i class="fas fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </form>

                    <div id="mensaje"></div>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="panel-section">
                <button class="accordion-header active" onclick="toggleAccordion(this)">
                    <div class="accordion-title">
                        <i class="fas fa-chart-pie"></i>
                        <span>Estad√≠sticas Generales</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </button>
                <div class="accordion-content" style="display: block;">
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
                            <div class="stat-content">
                                <span class="stat-value" id="statTotal">0</span>
                                <span class="stat-label">Sectores</span>
                            </div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-icon"><i class="fas fa-ruler-combined"></i></div>
                            <div class="stat-content">
                                <span class="stat-value" id="statArea">0 km¬≤</span>
                                <span class="stat-label">√Årea actual</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- fin right-panel -->
    </div> <!-- fin main-container -->
</div> <!-- fin trazabilidad-container -->

<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css">

<style>
:root {
    --primary-color: #3498db;
    --success-color: #27ae60;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --info-color: #16a085;
    --dark-color: #2c3e50;
    --gray-100: #f8f9fa;
    --gray-200: #e9ecef;
    --gray-300: #dee2e6;
    --gray-400: #ced4da;
    --gray-500: #adb5bd;
    --gray-600: #6c757d;
    --gray-700: #495057;
    --border-color: #dde3e9;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.12);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.trazabilidad-container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--gray-100);
}

.page-header {
    background: white;
    border-bottom: 2px solid var(--border-color);
    padding: 16px 24px;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.icon-wrapper {
    width: 48px;
    height: 48px;
    background: var(--primary-color);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    box-shadow: var(--shadow-sm);
}

.header-title h1 {
    font-size: 22px;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
    letter-spacing: -0.3px;
}

.header-title p {
    margin: 4px 0 0 0;
    font-size: 13px;
    color: var(--gray-600);
    font-weight: 400;
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    background: #2980b9;
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-outline {
    background: white;
    color: var(--dark-color);
    border: 2px solid var(--border-color);
}

.btn-outline:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    background: #f0f7ff;
}

.btn-secondary {
    background: var(--gray-500);
    color: white;
}

.btn-secondary:hover {
    background: var(--gray-600);
}

.btn-block {
    width: 100%;
}

.btn:disabled {
    background: var(--gray-300);
    color: var(--gray-500);
    cursor: not-allowed;
    box-shadow: none;
}

.main-container {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
}

.panel-collapsible {
    width: 360px;
    background: white;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    transition: var(--transition);
    z-index: 100;
    overflow: hidden;
}

.right-panel {
    border-right: none;
    border-left: 1px solid var(--border-color);
}

.panel-collapsible.collapsed {
    width: 0;
    border: none;
}

.panel-header {
    background: white;
    border-bottom: 2px solid var(--border-color);
    color: var(--dark-color);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
}

.panel-header h3 {
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    color: var(--dark-color);
}

.panel-header h3 i {
    color: var(--primary-color);
}

.btn-collapse {
    background: var(--gray-100);
    border: 1px solid var(--border-color);
    color: var(--gray-600);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.btn-collapse:hover {
    background: var(--gray-200);
    color: var(--dark-color);
}

.panel-expand-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    color: var(--dark-color);
    border: 2px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
    z-index: 99;
    font-size: 13px;
    font-weight: 600;
    writing-mode: vertical-rl;
}

.left-expand {
    left: 0;
    border-radius: 0 8px 8px 0;
    border-left: none;
}

.right-expand {
    right: 0;
    border-radius: 8px 0 0 8px;
    border-right: none;
}

.panel-expand-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.panel-section {
    border-bottom: 1px solid var(--border-color);
    overflow: hidden;
}

.panel-section.flex-grow {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.accordion-header {
    width: 100%;
    background: white;
    border: none;
    padding: 14px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
    font-weight: 600;
    color: var(--dark-color);
}

.accordion-header:hover {
    background: var(--gray-100);
}

.accordion-header.active {
    background: #f0f7ff;
    color: var(--primary-color);
}

.accordion-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
}

.accordion-title i {
    font-size: 16px;
}

.accordion-icon {
    transition: transform 0.3s;
    color: var(--gray-500);
}

.accordion-header.active .accordion-icon {
    transform: rotate(180deg);
    color: var(--primary-color);
}

.accordion-content {
    padding: 16px 20px;
    display: none;
}

.panel-section.flex-grow .accordion-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.map-styles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.map-style-card {
    background: var(--gray-100);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 16px 12px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-700);
}

.map-style-card i {
    font-size: 24px;
    color: var(--gray-600);
}

.map-style-card:hover {
    background: #f0f7ff;
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.map-style-card:hover i {
    color: var(--primary-color);
}

.map-style-card.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-md);
}

.map-style-card.active i {
    color: white;
}

.tools-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.tool-item {
    background: var(--gray-100);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 14px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 14px;
    color: var(--gray-700);
}

.tool-item i {
    font-size: 18px;
    color: var(--gray-600);
}

.tool-item:hover {
    background: #f0f7ff;
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateX(4px);
}

.tool-item:hover i {
    color: var(--primary-color);
}

.tool-item.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-md);
}

.tool-item.active i {
    color: white;
}

.search-box {
    position: relative;
    margin-bottom: 12px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-size: 14px;
}

.search-box input {
    width: 100%;
    padding: 10px 10px 10px 36px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--gray-100);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: white;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.sectores-list {
    flex: 1;
    overflow-y: auto;
}

.sector-item {
    background: var(--gray-100);
    padding: 12px 14px;
    margin-bottom: 8px;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.sector-item:hover {
    background: #f0f7ff;
    transform: translateX(4px);
    box-shadow: var(--shadow-sm);
}

.sector-item strong {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dark-color);
    margin-bottom: 6px;
    font-size: 14px;
}

.sector-item small {
    color: var(--gray-600);
    font-size: 12px;
}

.sector-item .sector-actions {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: var(--transition);
}

.sector-item:hover .sector-actions {
    opacity: 1;
}

.sector-actions .btn-icon {
    padding: 6px 10px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: var(--transition);
    color: var(--gray-700);
}

.sector-actions .btn-icon:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.sector-actions .btn-icon.delete:hover {
    background: var(--danger-color);
    border-color: var(--danger-color);
}

.form-group {
    margin-bottom: 18px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 13px;
    color: var(--dark-color);
}

.required {
    color: var(--danger-color);
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--gray-100);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    background: white;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

textarea.form-control {
    resize: vertical;
    font-family: inherit;
    min-height: 70px;
}

.form-hint {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--gray-600);
}

.polygon-status {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: #fff3cd;
    border: 2px solid var(--warning-color);
    border-radius: 8px;
    margin-bottom: 16px;
}

.polygon-status i {
    color: #856404;
    font-size: 18px;
    margin-top: 2px;
}

.polygon-status strong {
    display: block;
    color: #856404;
    font-size: 13px;
    margin-bottom: 2px;
}

.polygon-status p {
    color: #856404;
    font-size: 12px;
    margin: 0;
}

.polygon-status.success {
    background: #d4edda;
    border-color: var(--success-color);
}

.polygon-status.success i,
.polygon-status.success strong,
.polygon-status.success p {
    color: #155724;
}

.form-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 16px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.stat-card {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-card.blue {
    border-color: var(--primary-color);
    background: #f0f7ff;
}

.stat-card.green {
    border-color: var(--success-color);
    background: #f0fdf4;
}

.stat-icon {
    width: 46px;
    height: 46px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.stat-card.blue .stat-icon {
    background: var(--primary-color);
    color: white;
}

.stat-card.green .stat-icon {
    background: var(--success-color);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-value {
    display: block;
    font-size: 20px;
    font-weight: 700;
    color: var(--dark-color);
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    display: block;
    font-size: 11px;
    color: var(--gray-600);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.map-wrapper {
    flex: 1;
    position: relative;
    background: var(--gray-200);
}

#map {
    height: 100%;
    width: 100%;
}

.map-legend {
    position: absolute;
    top: 20px;
    left: 20px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 14px;
    box-shadow: var(--shadow-lg);
    z-index: 10;
    min-width: 200px;
}

.legend-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 13px;
    color: var(--dark-color);
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

.legend-header i {
    color: var(--primary-color);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--gray-700);
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid white;
    box-shadow: 0 0 0 1px var(--border-color);
}

.status-bar {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid var(--border-color);
    padding: 10px 20px;
    border-radius: 24px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 10;
    max-width: 90%;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-700);
}

.status-dot {
    color: var(--success-color);
    font-size: 8px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.status-divider {
    width: 2px;
    height: 20px;
    background: var(--border-color);
}

.map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 10;
}

.map-control-btn {
    width: 40px;
    height: 40px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
    color: var(--gray-700);
    transition: var(--transition);
}

.map-control-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    font-size: 11px;
    font-weight: 700;
    border-radius: 12px;
}

.badge-primary {
    background: var(--primary-color);
    color: white;
}

.badge-success {
    background: var(--success-color);
    color: white;
}

.alert {
    padding: 12px 14px;
    border-radius: 8px;
    margin-top: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-left: 4px solid;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border-color: var(--success-color);
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border-color: var(--danger-color);
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border-color: var(--warning-color);
}

.loading-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray-500);
}

.loading-state i {
    font-size: 32px;
    margin-bottom: 12px;
    color: var(--primary-color);
}

.loading-state p {
    margin: 0;
    font-size: 14px;
    color: var(--gray-600);
}

.sectores-list::-webkit-scrollbar,
.accordion-content::-webkit-scrollbar {
    width: 6px;
}

.sectores-list::-webkit-scrollbar-track,
.accordion-content::-webkit-scrollbar-track {
    background: var(--gray-100);
}

.sectores-list::-webkit-scrollbar-thumb,
.accordion-content::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: 10px;
}

.sectores-list::-webkit-scrollbar-thumb:hover,
.accordion-content::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
}

.mapboxgl-popup-content {
    padding: 16px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    border: 2px solid var(--border-color);
    min-width: 260px;
}

.mapboxgl-popup-close-button {
    font-size: 20px;
    padding: 8px;
    color: var(--gray-600);
    right: 8px;
    top: 8px;
}

.mapboxgl-popup-close-button:hover {
    color: var(--dark-color);
    background: var(--gray-100);
    border-radius: 4px;
}

.mapbox-gl-draw_polygon-and-line-vertex-active {
    cursor: move !important;
}

.mapbox-gl-draw_polygon-midpoint {
    cursor: cell !important;
}

@media (max-width: 1400px) {
    .panel-collapsible {
        width: 340px;
    }
}

@media (max-width: 1200px) {
    .panel-collapsible {
        width: 320px;
    }
}

@media (max-width: 992px) {
    .page-header {
        padding: 12px 16px;
    }

    .header-title h1 {
        font-size: 18px;
    }

    .header-title p {
        font-size: 12px;
    }

    .icon-wrapper {
        width: 42px;
        height: 42px;
        font-size: 20px;
    }

    .panel-collapsible {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 340px;
        max-width: 85vw;
        z-index: 200;
        transform: translateX(-100%);
    }

    .right-panel {
        right: 0;
        left: auto;
        transform: translateX(100%);
    }

    .panel-collapsible.active {
        transform: translateX(0);
    }

    .panel-expand-btn {
        display: none !important;
    }

    .map-legend {
        top: 10px;
        left: 10px;
        min-width: 160px;
        padding: 10px;
    }

    .status-bar {
        bottom: 80px;
        padding: 8px 16px;
    }

    .map-controls {
        top: 10px;
        right: 10px;
    }

    .btn span {
        display: none;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .map-styles-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .panel-collapsible {
        width: 100%;
        max-width: 100%;
    }

    .header-actions {
        width: 100%;
        justify-content: flex-end;
    }

    .map-legend {
        font-size: 11px;
    }

    .legend-color {
        width: 16px;
        height: 16px;
    }
}
</style>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

<script>
const API_URL = '{{ BASE_URL }}';
const MAPBOX_TOKEN = 'pk.eyJ1IjoicGVkcm8xMjNhYmMiLCJhIjoiY21hcGh0YWRmMGk0ZTJscTc0Yml2djM2MSJ9.RdRrSKRsvzGdhNNCDBxPiA';

mapboxgl.accessToken = MAPBOX_TOKEN;

let map;
let draw;
let sectoresData = {};
let currentPolygonId = null;
let modoEdicion = false;
let sectorEnEdicion = null;
let sectoresSourceAdded = false;
let estaDibujando = false;
let mapaListo = false;

function initMap() {
    console.log('üöÄ Inicializando mapa...');

    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-79.8145, -6.8650],
        zoom: 13
    });

    draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {},
        defaultMode: 'simple_select',
        styles: [
            {
                'id': 'gl-draw-polygon-fill',
                'type': 'fill',
                'filter': ['all', ['==', '$type', 'Polygon'], ['!=', 'mode', 'static']],
                'paint': {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.3
                }
            },
            {
                'id': 'gl-draw-polygon-stroke-active',
                'type': 'line',
                'filter': ['all', ['==', '$type', 'Polygon'], ['!=', 'mode', 'static']],
                'paint': {
                    'line-color': '#3498db',
                    'line-dasharray': [2, 2],
                    'line-width': 3
                }
            },
            {
                'id': 'gl-draw-polygon-and-line-vertex-active',
                'type': 'circle',
                'filter': ['all', ['==', 'meta', 'vertex'], ['==', '$type', 'Point']],
                'paint': {
                    'circle-radius': 8,
                    'circle-color': '#fff',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#3498db'
                }
            },
            {
                'id': 'gl-draw-polygon-midpoint',
                'type': 'circle',
                'filter': ['all', ['==', 'meta', 'midpoint'], ['==', '$type', 'Point']],
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#fff',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#3498db',
                    'circle-opacity': 0.8
                }
            }
        ]
    });

    map.addControl(draw);

    map.on('load', function() {
        console.log('‚úÖ Mapa cargado completamente');
        mapaListo = true;
        cargarSectoresExistentes();
        updateStatus('Sistema listo');
    });

    map.on('mousemove', function(e) {
        document.getElementById('coordinates').textContent =
            `${e.lngLat.lng.toFixed(4)}, ${e.lngLat.lat.toFixed(4)}`;
    });

    setupMapEvents();
}

function setupMapEvents() {
    map.on('draw.create', function(e) {
        console.log('‚úÖ Pol√≠gono creado exitosamente');
        estaDibujando = false;

        const feature = e.features[0];
        currentPolygonId = feature.id;

        calcularAreaPoligono(feature);
        actualizarEstadoPoligono(true);

        setTimeout(() => {
            try {
                draw.changeMode('simple_select');
                document.getElementById('cancelDraw').style.display = 'none';
                document.querySelectorAll('.tool-item').forEach(btn => btn.classList.remove('active'));

                if (map.getLayer('sectores-fill')) {
                    habilitarInteraccionSectores();
                }

                updateStatus('Pol√≠gono creado - Completa el formulario');
                mostrarMensaje('‚úÖ Pol√≠gono creado. Completa los datos del formulario.', 'success');
            } catch (error) {
                console.error('Error al cambiar modo:', error);
            }
        }, 150);
    });

    map.on('draw.update', function(e) {
        if (e.features && e.features.length > 0) {
            const feature = e.features[0];
            calcularAreaPoligono(feature);
            updateStatus('Pol√≠gono modificado');
            console.log('üìù Pol√≠gono actualizado');
        }
    });

    map.on('draw.delete', function() {
        currentPolygonId = null;
        actualizarEstadoPoligono(false);
        updateStatus('Pol√≠gono eliminado');
        mostrarMensaje('Pol√≠gono eliminado', 'warning');
        console.log('üóëÔ∏è Pol√≠gono eliminado');
    });

    map.on('draw.modechange', function(e) {
        console.log('üîÑ Modo cambi√≥ a:', e.mode);

        if (e.mode === 'draw_polygon') {
            estaDibujando = true;

            if (map.getLayer('sectores-fill')) {
                deshabilitarInteraccionSectores();
            }

            document.getElementById('cancelDraw').style.display = 'flex';
            document.getElementById('drawPolygon').classList.add('active');
            updateStatus('Dibujando pol√≠gono - Haz clic en el mapa para empezar');

        } else if (e.mode === 'simple_select') {
            document.getElementById('cancelDraw').style.display = 'none';

            if (!estaDibujando && map.getLayer('sectores-fill')) {
                setTimeout(() => {
                    habilitarInteraccionSectores();
                }, 200);
            }

        } else if (e.mode === 'direct_select') {
            updateStatus('Editando pol√≠gono - Mueve los v√©rtices');
        }
    });
}

function deshabilitarInteraccionSectores() {
    try {
        if (!mapaListo) return;

        if (map.getLayer('sectores-fill')) {
            map.setLayoutProperty('sectores-fill', 'visibility', 'visible');
            map.setPaintProperty('sectores-fill', 'fill-opacity', 0.05);
            console.log('üîí Interacci√≥n sectores deshabilitada');
        }
        if (map.getLayer('sectores-line')) {
            map.setPaintProperty('sectores-line', 'line-opacity', 0.2);
        }
        if (map.getLayer('sectores-labels')) {
            map.setLayoutProperty('sectores-labels', 'visibility', 'none');
        }
    } catch (error) {
        console.error('Error al deshabilitar sectores:', error);
    }
}

function habilitarInteraccionSectores() {
    try {
        if (!mapaListo) return;

        if (map.getLayer('sectores-fill')) {
            map.setPaintProperty('sectores-fill', 'fill-opacity', 0.15);
            console.log('üîì Interacci√≥n sectores habilitada');
        }
        if (map.getLayer('sectores-line')) {
            map.setPaintProperty('sectores-line', 'line-opacity', 1);
        }
        if (map.getLayer('sectores-labels')) {
            map.setLayoutProperty('sectores-labels', 'visibility', 'visible');
        }
    } catch (error) {
        console.error('Error al habilitar sectores:', error);
    }
}

function activarDibujo() {
    console.log('üñäÔ∏è Activando modo dibujo');

    if (currentPolygonId) {
        try {
            draw.delete(currentPolygonId);
            currentPolygonId = null;
            actualizarEstadoPoligono(false);
        } catch (error) {
            console.error('Error al eliminar pol√≠gono previo:', error);
        }
    }

    document.querySelectorAll('.tool-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById('drawPolygon').classList.add('active');

    try {
        draw.changeMode('draw_polygon');
        updateStatus('Modo dibujo activo - Haz clic en el mapa');
    } catch (error) {
        console.error('Error al activar dibujo:', error);
        mostrarMensaje('‚ùå Error al activar modo dibujo', 'error');
    }
}

function activarEdicion() {
    if (!currentPolygonId) {
        mostrarMensaje('‚ö†Ô∏è No hay pol√≠gono para editar. Dibuja uno primero.', 'warning');
        return;
    }

    console.log('‚úèÔ∏è Activando modo edici√≥n');

    document.querySelectorAll('.tool-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById('editShape').classList.add('active');

    try {
        draw.changeMode('direct_select', {
            featureId: currentPolygonId
        });

        updateStatus('Modo edici√≥n activo - Arrastra los puntos blancos');
        mostrarMensaje('üí° Arrastra los puntos para editar. Los puntos peque√±os agregan v√©rtices.', 'success');

    } catch (error) {
        console.error('Error al activar edici√≥n:', error);
        mostrarMensaje('‚ùå Error al activar edici√≥n', 'error');
    }
}

function cancelarDibujo() {
    console.log('‚ùå Cancelando dibujo');
    estaDibujando = false;

    document.querySelectorAll('.tool-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById('cancelDraw').style.display = 'none';

    try {
        draw.changeMode('simple_select');

        if (map.getLayer('sectores-fill')) {
            setTimeout(() => {
                habilitarInteraccionSectores();
            }, 200);
        }

        updateStatus('Dibujo cancelado');
    } catch (error) {
        console.error('Error al cancelar:', error);
    }
}

function eliminarForma() {
    if (!currentPolygonId) {
        mostrarMensaje('‚ö†Ô∏è No hay pol√≠gono para eliminar', 'warning');
        return;
    }

    if (confirm('¬øEliminar el pol√≠gono actual?')) {
        try {
            draw.delete(currentPolygonId);
            currentPolygonId = null;
            actualizarEstadoPoligono(false);
            updateStatus('Pol√≠gono eliminado');
            console.log('üóëÔ∏è Forma eliminada');
        } catch (error) {
            console.error('Error al eliminar:', error);
        }
    }
}

function limpiarMapa() {
    console.log('üßπ Limpiando mapa');

    if (currentPolygonId) {
        try {
            draw.delete(currentPolygonId);
        } catch (error) {
            console.error('Error al eliminar pol√≠gono:', error);
        }
    }

    try {
        draw.deleteAll();
        currentPolygonId = null;
        actualizarEstadoPoligono(false);

        document.querySelectorAll('.tool-item').forEach(btn => btn.classList.remove('active'));
        draw.changeMode('simple_select');

        document.getElementById('statArea').textContent = '0 km¬≤';

        updateStatus('Mapa limpiado');
    } catch (error) {
        console.error('Error al limpiar mapa:', error);
    }
}

function togglePanel(side) {
    const panel = document.getElementById(side === 'left' ? 'leftPanel' : 'rightPanel');
    const otherPanel = document.getElementById(side === 'left' ? 'rightPanel' : 'leftPanel');

    if (window.innerWidth <= 992) {
        otherPanel.classList.remove('active');
        panel.classList.toggle('active');
    }
}

function collapsePanel(side) {
    const panel = document.getElementById(side === 'left' ? 'leftPanel' : 'rightPanel');
    const expandBtn = document.querySelector(side === 'left' ? '.left-expand' : '.right-expand');

    panel.classList.add('collapsed');
    if (expandBtn) expandBtn.style.display = 'flex';
}

function expandPanel(side) {
    const panel = document.getElementById(side === 'left' ? 'leftPanel' : 'rightPanel');
    const expandBtn = document.querySelector(side === 'left' ? '.left-expand' : '.right-expand');

    panel.classList.remove('collapsed');
    if (expandBtn) expandBtn.style.display = 'none';
}

function toggleAccordion(button) {
    const content = button.nextElementSibling;
    const isActive = button.classList.contains('active');

    if (isActive) {
        button.classList.remove('active');
        content.style.display = 'none';
    } else {
        button.classList.add('active');
        content.style.display = 'block';
    }
}

function cambiarEstiloMapa(estilo, btn) {
    const sectoresSource = map.getSource('sectores');
    const sectoresGeoJSON = sectoresSource ? sectoresSource._data : null;

    document.querySelectorAll('.map-style-card').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    map.setStyle('mapbox://styles/mapbox/' + estilo);

    map.once('style.load', function() {
        if (sectoresGeoJSON && sectoresSourceAdded) {
            agregarCapaSectores(sectoresGeoJSON);
        }
    });

    updateStatus('Estilo actualizado');
}

function agregarCapaSectores(data) {
    try {
        if (map.getLayer('sectores-labels')) map.removeLayer('sectores-labels');
        if (map.getLayer('sectores-line')) map.removeLayer('sectores-line');
        if (map.getLayer('sectores-fill')) map.removeLayer('sectores-fill');
        if (map.getSource('sectores')) map.removeSource('sectores');

        map.addSource('sectores', {
            type: 'geojson',
            data: data
        });

        map.addLayer({
            id: 'sectores-fill',
            type: 'fill',
            source: 'sectores',
            paint: {
                'fill-color': [
                    'match',
                    ['get', 'tipo_zona'],
                    'picante', '#e74c3c',
                    'tranquila', '#3498db',
                    'normal', '#27ae60',
                    '#27ae60'
                ],
                'fill-opacity': 0.15
            }
        });

        map.addLayer({
            id: 'sectores-line',
            type: 'line',
            source: 'sectores',
            paint: {
                'line-color': [
                    'match',
                    ['get', 'tipo_zona'],
                    'picante', '#e74c3c',
                    'tranquila', '#3498db',
                    'normal', '#27ae60',
                    '#27ae60'
                ],
                'line-width': 3,
                'line-dasharray': [2, 1]
            }
        });

        map.addLayer({
            id: 'sectores-labels',
            type: 'symbol',
            source: 'sectores',
            layout: {
                'text-field': ['get', 'nombre'],
                'text-size': 12,
                'text-offset': [0, 0],
                'text-anchor': 'center'
            },
            paint: {
                'text-color': '#2c3e50',
                'text-halo-color': '#ffffff',
                'text-halo-width': 2
            }
        });

        setupSectoresClickEvents();
        console.log('‚úÖ Capas de sectores agregadas');
    } catch (error) {
        console.error('Error al agregar capas:', error);
    }
}

function setupSectoresClickEvents() {
    map.on('click', 'sectores-fill', function(e) {
        if (estaDibujando) return;

        const properties = e.features[0].properties;

        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <div style="min-width: 280px;">
                    <h4 style="margin: 0 0 12px 0; color: #2c3e50; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-map-marker-alt" style="color: #27ae60;"></i>
                        ${properties.nombre}
                    </h4>
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                        <p style="margin: 0 0 6px 0; font-size: 13px; color: #6c757d;">
                            <strong style="color: #2c3e50;">C√≥digo:</strong> ${properties.codigo_sector}
                        </p>
                        ${properties.descripcion ? `
                            <p style="margin: 6px 0 0 0; font-size: 12px; color: #6c757d; line-height: 1.5;">
                                ${properties.descripcion}
                            </p>
                        ` : ''}
                    </div>
                    <div style="background: #f0f7ff; border: 2px solid #3498db; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                        <p style="margin: 0; font-size: 14px; font-weight: 700; color: #2c3e50;">
                            <i class="fas fa-flag"></i>
                            Tipo de Zona: <strong>${properties.tipo_zona}</strong>
                        </p>
                    </div>
                    <p style="margin: 0 0 16px 0; font-size: 11px; color: #95a5a6;">
                        <i class="far fa-calendar-alt"></i> Creado: ${
                            properties.fecha_creacion
                                ? new Date(properties.fecha_creacion).toLocaleDateString('es-ES', {
                                      day: 'numeric',
                                      month: 'long',
                                      year: 'numeric'
                                  })
                                : 'No disponible'
                        }
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="cargarSectorParaEditar(${properties.id_sector})" 
                                style="flex: 1; padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="eliminarSector(${properties.id_sector})" 
                                style="flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `)
            .addTo(map);
    });

    map.on('mouseenter', 'sectores-fill', function() {
        if (!estaDibujando) {
            map.getCanvas().style.cursor = 'pointer';
        }
    });

    map.on('mouseleave', 'sectores-fill', function() {
        map.getCanvas().style.cursor = '';
    });
}

async function guardarSector() {
    if (!currentPolygonId) {
        mostrarMensaje('‚ö†Ô∏è Dibuja un pol√≠gono primero', 'error');
        return;
    }

    const codigo = document.getElementById('codigoSector').value.trim();
    const nombre = document.getElementById('nombreSector').value.trim();
    const descripcion = document.getElementById('descripcionSector').value.trim();
    const tipoZona = document.getElementById('tipoZona').value;
    const idSector = document.getElementById('sectorIdEdit').value;
    const esEdicion = document.getElementById('modoEdicion').value === 'true';

    if (!codigo || !nombre || !tipoZona) {
        mostrarMensaje('‚ö†Ô∏è C√≥digo, Nombre y Tipo de Zona son obligatorios', 'error');
        return;
    }

    const feature = draw.get(currentPolygonId);

    const sectorData = {
        codigo_sector: codigo,
        nombre: nombre,
        descripcion: descripcion,
        tipo_zona: tipoZona,
        poligono_geojson: feature,
        usuario_creacion: 'admin'
    };

    try {
        const url = esEdicion
            ? `${API_URL}/api/sectores/actualizar/${idSector}`
            : `${API_URL}/api/sectores/crear`;

        const method = esEdicion ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(sectorData)
        });

        const result = await response.json();

        if (result.success) {
            const mensaje = esEdicion
                ? '‚úÖ Sector actualizado correctamente'
                : '‚úÖ Sector guardado exitosamente';

            mostrarMensaje(mensaje, 'success');
            limpiarFormulario();
            limpiarMapa();

            if (modoEdicion) {
                cancelarEdicion();
            }

            await cargarSectoresExistentes();
            updateStatus('Operaci√≥n completada');
        } else {
            mostrarMensaje('‚ùå Error: ' + (result.error || 'Error desconocido'), 'error');
        }
    } catch (error) {
        mostrarMensaje('‚ùå Error: ' + error.message, 'error');
        console.error('Error:', error);
    }
}

async function cargarSectoresExistentes() {
    if (!mapaListo) {
        console.log('‚è≥ Esperando que el mapa est√© listo...');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/api/sectores/listar`);
        const data = await response.json();

        const listaSectores = document.getElementById('listaSectores');

        if (!data.success) {
            listaSectores.innerHTML = '<div class="loading-state"><i class="fas fa-exclamation-triangle"></i><p>Error al cargar sectores</p></div>';
            return;
        }

        sectoresData = {};

        if (data.data.length === 0) {
            listaSectores.innerHTML = '<div class="loading-state"><i class="fas fa-inbox"></i><p>No hay sectores registrados</p></div>';
            document.getElementById('totalSectores').textContent = '0';
            document.getElementById('statTotal').textContent = '0';
            return;
        }

        listaSectores.innerHTML = '';
        document.getElementById('totalSectores').textContent = data.data.length;
        document.getElementById('statTotal').textContent = data.data.length;

        const sectoresGeoJSON = {
            type: 'FeatureCollection',
            features: data.data.map(sector => {
                return {
                    type: 'Feature',
                    properties: {
                        id_sector: sector.id_sector,
                        codigo_sector: sector.codigo_sector,
                        nombre: sector.nombre,
                        descripcion: sector.descripcion,
                        fecha_creacion: sector.fecha_creacion,
                        tipo_zona: sector.tipo_zona || 'normal'
                    },
                    geometry: sector.poligono.geometry
                };
            })
        };

        if (!sectoresSourceAdded) {
            agregarCapaSectores(sectoresGeoJSON);
            sectoresSourceAdded = true;
        } else {
            map.getSource('sectores').setData(sectoresGeoJSON);
        }

        data.data.forEach(sector => {
            sectoresData[sector.id_sector] = sector;

            const itemHTML = `
                <div class="sector-item" onclick="centrarSector(${sector.centro.lat}, ${sector.centro.lon})">
                    <strong>
                        <i class="fas fa-map-pin"></i>
                        ${sector.nombre}
                    </strong>
                    <small>${sector.codigo_sector} ‚Ä¢ ${sector.tipo_zona ? sector.tipo_zona.toUpperCase() : 'NORMAL'}</small>
                    <br>
                    <span class="badge badge-success">
                        <i class="fas fa-check-circle"></i>
                        Activo
                    </span>
                    <div class="sector-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); cargarSectorParaEditar(${sector.id_sector})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="event.stopPropagation(); eliminarSector(${sector.id_sector})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            listaSectores.innerHTML += itemHTML;
        });

        console.log(`‚úÖ ${data.data.length} sectores cargados`);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('listaSectores').innerHTML =
            '<div class="loading-state"><i class="fas fa-exclamation-triangle"></i><p>Error al cargar sectores</p></div>';
    }
}

function cargarSectorParaEditar(idSector) {
    const sector = sectoresData[idSector];
    if (!sector) {
        mostrarMensaje('‚ùå Sector no encontrado', 'error');
        return;
    }

    console.log('üìù Cargando sector para editar:', sector.nombre);

    modoEdicion = true;
    sectorEnEdicion = idSector;

    document.getElementById('formTitle').textContent = 'Editar Sector';
    document.getElementById('formIcon').className = 'fas fa-edit';
    document.getElementById('btnGuardarTexto').textContent = 'Actualizar';
    document.getElementById('btnCancelar').style.display = 'block';
    document.getElementById('sectorIdEdit').value = idSector;
    document.getElementById('modoEdicion').value = 'true';
    document.getElementById('rightPanelTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Sector';

    document.getElementById('codigoSector').value = sector.codigo_sector;
    document.getElementById('nombreSector').value = sector.nombre;
    document.getElementById('descripcionSector').value = sector.descripcion || '';
    document.getElementById('tipoZona').value = sector.tipo_zona || 'normal';

    draw.deleteAll();

    if (sector.poligono) {
        const ids = draw.add(sector.poligono);
        currentPolygonId = ids[0];

        calcularAreaPoligono(sector.poligono);
        actualizarEstadoPoligono(true);

        const bounds = new mapboxgl.LngLatBounds();
        sector.poligono.geometry.coordinates[0].forEach(coord => {
            bounds.extend(coord);
        });
        map.fitBounds(bounds, { padding: 50 });
    }

    updateStatus('Editando: ' + sector.nombre);

    if (window.innerWidth <= 992) {
        togglePanel('right');
    }
}

function cancelarEdicion() {
    modoEdicion = false;
    sectorEnEdicion = null;

    document.getElementById('formTitle').textContent = 'Nuevo Sector';
    document.getElementById('formIcon').className = 'fas fa-plus-circle';
    document.getElementById('btnGuardarTexto').textContent = 'Guardar Sector';
    document.getElementById('btnCancelar').style.display = 'none';
    document.getElementById('sectorIdEdit').value = '';
    document.getElementById('modoEdicion').value = 'false';
    document.getElementById('rightPanelTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Gesti√≥n de Sectores';

    limpiarFormulario();
    limpiarMapa();

    updateStatus('Edici√≥n cancelada');
}

async function eliminarSector(idSector) {
    const sector = sectoresData[idSector];
    if (!sector) return;

    if (!confirm(`¬øEliminar permanentemente "${sector.nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }

    try {
        const response = await fetch(`${API_URL}/api/sectores/eliminar/${idSector}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            mostrarMensaje('‚úÖ Sector eliminado', 'success');
            await cargarSectoresExistentes();

            if (sectorEnEdicion === idSector) {
                cancelarEdicion();
            }
        } else {
            mostrarMensaje('‚ùå Error: ' + (result.error || 'Error desconocido'), 'error');
        }
    } catch (error) {
        mostrarMensaje('‚ùå Error: ' + error.message, 'error');
    }
}

function centrarSector(lat, lon) {
    map.flyTo({
        center: [lon, lat],
        zoom: 16,
        duration: 1000
    });
}

function filtrarSectores() {
    const busqueda = document.getElementById('searchSector').value.toLowerCase();
    const items = document.querySelectorAll('.sector-item');

    items.forEach(item => {
        const texto = item.textContent.toLowerCase();
        item.style.display = texto.includes(busqueda) ? 'block' : 'none';
    });
}

function calcularAreaPoligono(feature) {
    try {
        const area = turf.area(feature);
        const areaKm2 = (area / 1000000).toFixed(4);
        document.getElementById('statArea').textContent = `${areaKm2} km¬≤`;
    } catch (e) {
        console.error('Error al calcular √°rea:', e);
        document.getElementById('statArea').textContent = '0 km¬≤';
    }
}

function actualizarEstadoPoligono(dibujado) {
    const btnGuardar = document.getElementById('btnGuardar');
    const polygonStatus = document.getElementById('polygonStatus');

    if (dibujado) {
        btnGuardar.disabled = false;
        polygonStatus.classList.add('success');
        polygonStatus.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <div>
                <strong>Pol√≠gono listo</strong>
                <p>Completa el formulario y guarda</p>
            </div>
        `;
    } else {
        btnGuardar.disabled = true;
        polygonStatus.classList.remove('success');
        polygonStatus.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Pol√≠gono requerido</strong>
                <p>Dibuja un √°rea en el mapa</p>
            </div>
        `;
        document.getElementById('statArea').textContent = '0 km¬≤';
    }
}

function updateStatus(mensaje) {
    document.getElementById('mapStatus').textContent = mensaje;
}

function mostrarMensaje(texto, tipo) {
    const divMensaje = document.getElementById('mensaje');
    if (!texto) {
        divMensaje.innerHTML = '';
        return;
    }

    const icono = tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : 'exclamation-triangle';

    divMensaje.innerHTML = `
        <div class="alert alert-${tipo}">
            <i class="fas fa-${icono}"></i>
            <span>${texto}</span>
        </div>
    `;

    if (tipo === 'success') {
        setTimeout(() => divMensaje.innerHTML = '', 5000);
    }
}

function limpiarFormulario() {
    document.getElementById('formSector').reset();
    if (!modoEdicion) {
        document.getElementById('tipoZona').value = 'normal';
    }
}

function resetMapView() {
    map.flyTo({
        center: [-79.8145, -6.8650],
        zoom: 13,
        duration: 1000
    });
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando aplicaci√≥n de Trazabilidad de Sectores');

    initMap();
    updateStatus('Inicializando sistema...');

    document.getElementById('nombreSector').addEventListener('input', function() {
        if (document.getElementById('modoEdicion').value === 'true') return;

        const nombre = this.value.trim();
        const codigoInput = document.getElementById('codigoSector');

        if (nombre && !codigoInput.value) {
            const palabras = nombre.split(' ');
            let codigo = 'SECT-';

            if (palabras.length >= 2) {
                codigo += palabras[0].substring(0, 2).toUpperCase() +
                         palabras[1].substring(0, 2).toUpperCase();
            } else {
                codigo += palabras[0].substring(0, 4).toUpperCase();
            }

            codigoInput.value = codigo;
        }
    });

    document.getElementById('map').addEventListener('click', function() {
        if (window.innerWidth <= 992 && !estaDibujando) {
            document.querySelectorAll('.panel-collapsible').forEach(p => p.classList.remove('active'));
        }
    });

    console.log('‚úÖ Sistema inicializado');
});
</script>

{% endblock %}
