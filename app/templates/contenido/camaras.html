<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>C√°maras de Seguridad | MP Chiclayo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

    <style>
        :root {
            --municipio-rojo: #C62828;
            --municipio-dorado: #FFC107;
            --azul-oscuro: #0D1B2A;
            --gris-fondo: #f5f7fb;
        }

        body {
            background-color: var(--gris-fondo);
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .btn-muni {
            background-color: var(--municipio-rojo);
            color: white;
            border-radius: 8px;
        }

        .btn-muni:hover {
            background-color: #A61F1F;
        }

        .titulo-muni {
            color: var(--municipio-rojo);
            font-weight: 700;
        }

        #mapCamaras {
            height: 650px;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
        }

        .sidebar {
            height: 650px;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0px 4px 25px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .sidebar h5 {
            color: var(--azul-oscuro);
            font-weight: bold;
        }

        .legend i {
            width: 14px;
            height: 14px;
            display: inline-block;
            border-radius: 999px;
            margin-right: 6px;
        }

        .floating-btn {
            position: absolute;
            bottom: 20px;
            right: 40px;
            background: var(--municipio-rojo);
            color: white;
            padding: 14px 18px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .floating-btn:hover {
            background: #A61F1F;
        }
    </style>
</head>

<body>

<div class="container-fluid px-4 mt-3">

    <div class="d-flex justify-content-between align-items-center">
        <h2 class="titulo-muni">Mapa de C√°maras de Seguridad ‚Ä¢ Chiclayo</h2>
        <button id="btnRefrescar" class="btn btn-muni">
            <i class="fa-solid fa-rotate"></i> Refrescar
        </button>
    </div>

    <div class="row mt-4">

        <!-- MAPA -->
        <div class="col-lg-9">
            <div id="mapCamaras"></div>
        </div>

        <!-- LISTA Y FORMULARIO -->
        <div class="col-lg-3">
            <div class="sidebar">

                <h5>üìπ C√°maras registradas</h5>

                <div class="legend mb-2">
                    <div><i style="background:#22c55e"></i> Activa</div>
                    <div><i style="background:#ef4444"></i> Inactiva</div>
                </div>

                <div class="list-group mb-4" id="listaCamaras">
                    <!-- se llena din√°micamente -->
                </div>

                <hr>

                <h5>‚ûï Registrar nueva c√°mara</h5>

                <form id="formCamara">
                    <label class="mt-2 fw-bold">Nombre</label>
                    <input class="form-control" name="nombre" required>

                    <label class="mt-2 fw-bold">RTSP / IP</label>
                    <input class="form-control" name="rtsp_url" placeholder="rtsp://usuario:pass@ip:puerto..." required>

                    <label class="mt-2 fw-bold">Latitud</label>
                    <input class="form-control" name="lat" id="lat" required>

                    <label class="mt-2 fw-bold">Longitud</label>
                    <input class="form-control" name="lon" id="lon" required>

                    <label class="mt-2 fw-bold mt-2">Estado</label>
                    <select class="form-select" name="estado">
                        <option value="activa">Activa</option>
                        <option value="inactiva">Inactiva</option>
                    </select>

                    <button class="btn btn-muni w-100 mt-3">
                        Guardar C√°mara
                    </button>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n flotante para activar selecci√≥n en mapa -->
<div class="floating-btn" onclick="activarSeleccion()">
    <i class="fa-solid fa-location-dot"></i> Seleccionar Ubicaci√≥n
</div>

<script>
    let map;
    let markersLayer = L.layerGroup();
    let seleccionActiva = false;
    let marcadorSeleccion = null;

    const CHICLAYO_CENTER = [-6.7715, -79.8409];

    document.addEventListener("DOMContentLoaded", () => {
        initMap();
        cargarCamaras();

        document.getElementById("btnRefrescar").addEventListener("click", cargarCamaras);
        document.getElementById("formCamara").addEventListener("submit", registrarCamara);
    });

    /** Inicializa mapa */
    function initMap() {
        map = L.map("mapCamaras").setView(CHICLAYO_CENTER, 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        markersLayer.addTo(map);

        // evento para selecci√≥n de coordenadas
        map.on("click", function(e) {
            if (seleccionActiva) {

                // eliminar marcador previo
                if (marcadorSeleccion) {
                    map.removeLayer(marcadorSeleccion);
                }

                const { lat, lng } = e.latlng;

                // crear marcador rojo
                marcadorSeleccion = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    })
                }).addTo(map);

                // llenar los inputs
                document.getElementById("lat").value = lat.toFixed(6);
                document.getElementById("lon").value = lng.toFixed(6);

                seleccionActiva = false;

                alert("üìç Ubicaci√≥n seleccionada");
            }
        });
    }

    /** Activa modo selecci√≥n de ubicaci√≥n */
    function activarSeleccion() {
        seleccionActiva = true;
        alert("Haz clic en el mapa donde estar√° la c√°mara");
    }

    /** Cargar c√°maras */
    async function cargarCamaras() {
        markersLayer.clearLayers();

        const lista = document.getElementById("listaCamaras");
        lista.innerHTML = "<div class='text-muted'>Cargando...</div>";

        const resp = await fetch("/api/camaras");
        const camaras = await resp.json();

        lista.innerHTML = "";

        camaras.forEach(c => {
            if (!c.lat || !c.lon) return;

            const color = c.estado === "activa" ? "#22c55e" : "#ef4444";

            const marker = L.circleMarker([c.lat, c.lon], {
                radius: 10,
                fillColor: color,
                color: "#ffffff",
                weight: 2,
                fillOpacity: 0.9
            }).addTo(markersLayer);

            marker.bindPopup(`
                <strong>${c.nombre}</strong><br>
                <small>${c.rtsp_url}</small><br>
                <span class="badge bg-${c.estado === "activa" ? "success" : "danger"}">${c.estado}</span>
            `);

            const item = document.createElement("button");
            item.className = "list-group-item list-group-item-action";
            item.innerHTML = `<strong>${c.nombre}</strong><br><small>${c.estado}</small>`;
            item.onclick = () => {
                map.setView([c.lat, c.lon], 17);
                marker.openPopup();
            };

            lista.appendChild(item);
        });
    }

    /** Registrar c√°mara */
    async function registrarCamara(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));

        const resp = await fetch("/api/camaras", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });

        if (resp.ok) {
            alert("üéâ C√°mara registrada exitosamente");
            cargarCamaras();
            e.target.reset();

            // eliminar marcador de selecci√≥n
            if (marcadorSeleccion) {
                map.removeLayer(marcadorSeleccion);
                marcadorSeleccion = null;
            }

        } else {
            alert("Error al registrar c√°mara");
        }
    }
</script>


</body>
</html>
